name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  pre-deploy-tests:
    name: Pre-Deploy Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test

      - name: Run lint
        run: pnpm run lint

      - name: Check TypeScript
        run: npx tsc --noEmit

  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: pre-deploy-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run database migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Verify migration status
        run: npx prisma migrate status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  trigger-vercel-deployment:
    name: Trigger Vercel Deployment
    runs-on: ubuntu-latest
    needs: migrate-database

    steps:
      - name: Trigger Vercel Deploy Hook
        run: |
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'

      - name: Wait for deployment
        run: |
          echo "Waiting for Vercel deployment to complete..."
          sleep 30

  post-deploy-verification:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: trigger-vercel-deployment

    steps:
      - name: Health Check with Retry
        run: |
          for i in {1..5}; do
            if curl -f -s "${{ secrets.PRODUCTION_URL }}" > /dev/null; then
              echo "✅ Production site is responding"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 30s..."
            sleep 30
          done
          echo "❌ Production site health check failed after 5 attempts"
          exit 1

      - name: Database Connection Check
        run: |
          # You can add a simple API endpoint like /api/health that checks DB connection
          if curl -f -s "${{ secrets.PRODUCTION_URL }}/api/health" > /dev/null; then
            echo "✅ Database connection verified"
          else
            echo "⚠️  Database health check endpoint not available or failed"
          fi
